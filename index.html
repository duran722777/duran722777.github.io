<script>
// ----------------------- 전역 -----------------------
let currentGame=null;
const scoreBox=document.getElementById('scoreBox');
const highScoreBox=document.getElementById('highScoreBox');
const timeBox=document.getElementById('timeBox');

function animateScore(score,element){
  element.style.transform='scale(1.5)';
  element.textContent=`점수: ${score}`;
  setTimeout(()=>element.style.transform='scale(1)',200);
}

function updateHighScore(game,score){
  const key='highScore_'+game;
  let high=localStorage.getItem(key) || 0;
  if(score>high){ localStorage.setItem(key,score); high=score; showCongrats(); }
  return high;
}

function showCongrats(){
  const c=document.createElement('div');
  c.className='congrats';
  c.textContent='🎉 신기록! 🎉';
  c.style.left=window.innerWidth/2-100+'px';
  c.style.top=100+window.scrollY+'px';
  document.body.appendChild(c);
  setTimeout(()=>c.remove(),2000);
}

// ----------------------- 게임: 클릭 제한 -----------------------
document.getElementById('clickGameBtn').addEventListener('click',()=>{
  resetCookie();
  currentGame='clickGame';
  let score=0;
  scoreBox.textContent=`점수: ${score}`;
  clickHint.textContent='10초 안에 쿠키를 최대한 클릭하세요!';
  clickHint.style.display='block';
  cookie.style.position='relative';
  cookie.style.left='0px';
  cookie.style.top='0px';

  const clickHandler=()=>{
    score++;
    animateScore(score,scoreBox);
    const rect=cookie.getBoundingClientRect();
    createGlitter(rect.left+rect.width/2, rect.top+rect.height/2);
  };
  cookie.addEventListener('click',clickHandler);

  let timeLeft=10;
  timeBox.textContent=`남은 시간: ${timeLeft}s`;
  const timer=setInterval(()=>{
    timeLeft--;
    timeBox.textContent=`남은 시간: ${timeLeft}s`;
  },1000);

  setTimeout(()=>{
    clearInterval(timer);
    cookie.removeEventListener('click',clickHandler);
    clickHint.textContent=`게임 종료! 최종 점수: ${score}`;
    updateHighScore('clickGame',score);
    currentGame=null;
    timeBox.textContent='';
  },10000);
});

// ----------------------- 게임: 움직이는 쿠키 -----------------------
document.getElementById('moveGameBtn').addEventListener('click',()=>{
  resetCookie();
  currentGame='moveGame';
  let score=0;
  scoreBox.textContent=`점수: ${score}`;
  clickHint.textContent='움직이는 쿠키를 클릭하세요!';
  clickHint.style.display='block';
  cookie.style.position='absolute';

  const moveInterval=setInterval(()=>{
    const x=Math.random()*(window.innerWidth-100);
    const y=window.scrollY+100+Math.random()*(window.innerHeight-200);
    cookie.style.left=`${x}px`;
    cookie.style.top=`${y}px`;
  },500); // 속도 증가

  const clickHandler=()=>{
    score++;
    animateScore(score,scoreBox);
    const rect=cookie.getBoundingClientRect();
    createGlitter(rect.left+rect.width/2, rect.top+rect.height/2);
  };
  cookie.addEventListener('click',clickHandler);

  let timeLeft=15;
  timeBox.textContent=`남은 시간: ${timeLeft}s`;
  const timer=setInterval(()=>{
    timeLeft--;
    timeBox.textContent=`남은 시간: ${timeLeft}s`;
  },1000);

  setTimeout(()=>{
    clearInterval(moveInterval);
    clearInterval(timer);
    cookie.removeEventListener('click',clickHandler);
    clickHint.textContent=`게임 종료! 최종 점수: ${score}`;
    updateHighScore('moveGame',score);
    currentGame=null;
    timeBox.textContent='';
  },15000);
});

// ----------------------- 작은 캐릭터 랜덤 등장 -----------------------
function spawnSmallChar(){
  if(Math.random()<0.03 && !currentGame){
    const char=document.createElement('img');
    char.src='https://cdn-icons-png.flaticon.com/512/616/616408.png';
    char.className='small-char';
    char.style.left=Math.random()*(window.innerWidth-50)+'px';
    char.style.top=(window.scrollY+50+Math.random()*(window.innerHeight-100))+'px';
    document.body.appendChild(char);
    char.addEventListener('click',()=>{
      const rect=char.getBoundingClientRect();
      createGlitter(rect.left+25, rect.top+25,'#ff0');
      popupScore(rect.left+25, rect.top+25,'+3');
      typeMessage('작은 친구가 행운을 가져왔어요! 🎉');
      char.remove();
    });
    setTimeout(()=>{ if(char.parentNode) char.remove(); },5000);
  }
}
setInterval(spawnSmallChar,1000);

// ----------------------- 쿠키 초기화 -----------------------
function resetCookie(){
  cookie.style.position='relative';
  cookie.style.left='0px';
  cookie.style.top='0px';
}
</script>
